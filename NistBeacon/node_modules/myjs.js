var beacon = require('nist-beacon');
var epochTime = 1510400028;
// var str = '';
// var convertResult = 

var fs = require("fs");
	// Asynchronous - Opening File
	var outFileName = process.argv[3];
	fs.open(outFileName, 'w', function(err, fd) {
		if (err) {
		  return console.error(err);
		}
		
		//process.argv[2] == count of Kbites, because one iteration == 64 bytes (512 bits)
		for (var j = 0; j < process.argv[2] * 2; j++) {
			beacon.currentRecord(epochTime + j * 60, function (err, res) {
		  // prints the beacon value closest to epochTime in 128 hex characters (or 64 chars)
		  
				var hex = res, // ASCII HEX: 37="7", 57="W", 71="q"
					bytes = [];
				var str = '';
				for(var i=0; i < hex.length - 1; i += 2){
					//bytes.push(parseInt(hex.substr(i, 2), 16));
					var ch = parseInt(hex.substr(i, 2), 16);
					for (var j = 0; j < 8; j++) {
						if ((ch & (1 << j)) == 0)
							bytes.push('0'.charCodeAt(0));
						else
							bytes.push('1'.charCodeAt(0));
					}
					//bytes.push(64);
				}

				str = String.fromCharCode.apply(String, bytes);
				fs.appendFile(outFileName, str, function (err) {
					if (err) {
						return console.error(err);
					}
				});	  
				
			});
		}
		
		
		fs.close(fd, function (err) {
				if (err) {
					return console.error(err);
				}
			});
	});


//console.log(str);


